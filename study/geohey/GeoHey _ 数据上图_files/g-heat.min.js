G.Layer.Heat=G.Layer.extend({mixins:[G.Layer.Filter],options:{radius:30,radiusUnit:"pixel",maxOpacity:1,minOpacity:0,colors:{"0.2":"#00f","0.4":"#0ff","0.6":"#0f0","0.8":"#ff0",1:"#f00"},topValue:5,drawResolution:1,drawOnAnim:!1},init:function(a){this.options=G.Util.merge({},this.options,a);this._idSeq=0;this._dataPoints={};this._tree=new G.RTree;this._updateColorsImage();this._dirty=!0;this._builtExtent=[]},_onResize:function(){var a=this._map,b=Math.max(this.options.drawResolution,1),a=(a._useOffScreen?
a._offScreenCtx:a._onScreenCtx).canvas,d=this._ctx.canvas,c=this._actx.canvas,f=G.Browser.getCanvasRatio();this._bkScale=Math.max(f?f[0]||1:1,f?f[1]||1:1)*b;d.width=c.width=a.width/this._bkScale;d.height=c.height=a.height/this._bkScale;this._dirty=!0},_initContainer:function(){var a=this._map,b=G.DomUtil;this._ctx||(this._ctx=b.create("canvas").getContext("2d"));this._actx||(this._actx=b.create("canvas").getContext("2d"));this._cctx||(this._cctx=G.DomUtil.create("canvas").getContext("2d"));a.addListener("resize",
this._onResize,this);a.addListener("moveEnd",this._onExtentChanged,this);a.addListener("zoomEnd",this._onExtentChanged,this);this._onResize()},_onAdded:function(){var a=this._map;this._initContainer();a._requestUpdate()},_onRemoved:function(){var a=this._map;a.removeListener("resize",this._onResize,this);a.removeListener("moveEnd",this._onExtentChanged,this);a.removeListener("zoomEnd",this._onExtentChanged,this)},_onExtentChanged:function(a){var b=this;a=b._map;var d=a.getExtent();G.ExtentUtil.equals(d,
b._builtExtent,2*a._res)||setTimeout(function(){b._dirty=!0},50)},updateColors:function(){this._updateColorsImage()},addDataPoint:function(a,b,d,c,f){var g=this._map,e=[a,b,a,b];d=d||1;c=G.Util.isObject(c)?c:{};a={x:a,y:b,val:d,attrs:c};a.bbox=e;a._id=this._idSeq++;a._addAt=+new Date;this._dataPoints[a._id]=a;this._tree.insert(e,a);this._dirty=!0;f&&g&&g._requestRedraw();return a._id},removeDataPoint:function(a,b){var d=this._map,c=this._dataPoints[a];if(!c)return this;delete this._dataPoints[a];
this._tree.remove(c.bbox,c);this._dirty=!0;b&&d&&d._requestRedraw();return this},clear:function(a){var b=this._map;this._dataPoints={};this._tree.clear();this._dirty=!0;!a&&b&&b._requestRedraw();return this},_update:function(){this._dirty=!0;this._draw()},_draw:function(){var a=this._map,b=this.options,d=this._ctx,c=d.canvas,f=c.width,c=c.height;if(this._dirty){var g=b.radius;"pixel"==b.radiusUnit&&(g*=a._res);var e=a.getCenter(),l=a._res,k=a.getDrawSize(),h=k[0],k=k[1],g=G.ExtentUtil.intersect([e[0]-
h*l/2-g,e[1]-k*l/2-g,e[0]+h*l/2+g,e[1]+k*l/2+g],a.options.maxExtent);if(!b.drawOnAnim&&(a.isZooming()||a.isPinching()||a.isRotating()||a.isPanning()))return;g=this._tree.search(g);if(!g)return;var m,e=this._actx,h=e.canvas,l=h.width,k=h.height;e.clearRect(0,0,l,k);for(m in g){var h=g[m],n=h._passFilters;n||(n=h._passFilters=this._calcFilter(h.attrs)?1:-1);n&&this._drawA(h.x,h.y,h.val)}var g=e.getImageData(0,0,l,k),e=g.data,l=e.length,h=Math.min(parseInt(255*b.maxOpacity),255),b=Math.min(h,Math.min(parseInt(255*
b.minOpacity),255)),k=this._colorsImage,p;for(m=0;m<l-3;m+=4)(n=e[m+3])?(p=4*n,e[m]=k[p],e[m+1]=k[p+1],e[m+2]=k[p+2],e[m+3]=b+(h-b)*n/255):0<b&&(e[m]=k[0],e[m+1]=k[1],e[m+2]=k[2],e[m+3]=b);g.data=e;d.clearRect(0,0,f,c);d.putImageData(g,0,0,0,0,f,c);this._dirty=!1;this._builtExtent=a.getExtent()}this._hidden||(a=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,f=a.canvas,a.drawImage(d.canvas,0,0,f.width,f.height))},_updateColorsImage:function(){var a=G.DomUtil.create("canvas").getContext("2d"),b=a.canvas;
b.width=1;b.height=256;var b=this.options.colors,d=a.createLinearGradient(0,0,1,256),c;for(c in b)d.addColorStop(c,b[c]);a.fillStyle=d;a.fillRect(0,0,1,256);this._colorsImage=a.getImageData(0,0,1,256).data},_updateCircle:function(a,b){var d=this._cctx,c=d.canvas,f=a+2*b,g=2*f;c.width=c.height=2*f;d.shadowColor="#000";d.shadowOffsetX=d.shadowOffsetY=g;d.shadowBlur=b;d.beginPath();d.arc(f-g,f-g,a,0,2*Math.PI,!0);d.closePath();d.fill();this._circleRadius=a;this._circleR=f;return this},_drawA:function(a,
b,d){var c=this._map,f=this.options;if(d){var g=f.topValue,e=f.radius/this._bkScale;"map"==f.radiusUnit&&(e/=c._res);this._circleRadius&&this._circleRadius==e||this._updateCircle(e,e);f=this._actx;e=c._canvasOffset;b=c.toScreen([a,b]);a=b[0]+e[0];b=b[1]+e[1];d=Math.min(1,d/g);f.globalAlpha=d;f.drawImage(this._cctx.canvas,a/this._bkScale-this._circleR,b/this._bkScale-this._circleR)}}});
G.Layer.TiledHeat=G.Layer.TiledService.extend({mixins:[G.Layer.LOD,G.Layer.Filter],options:{cluster:[],responseType:"json",radius:30,radiusUnit:"pixel",maxOpacity:1,minOpacity:0,colors:{"0.2":"#00f","0.4":"#0ff","0.6":"#0f0","0.8":"#ff0",1:"#f00"},topValue:5,drawResolution:1,drawOnAnim:!1},init:function(a,b,d){var c=this;c.url=a;c._dataFunc=b;c.options=G.Util.merge({},c.options,d);c._tiles={};c._dirtyTiles={};c._dirty=!0;G.Layer.TiledService.prototype.init.call(c,function(a,d,e){var l=c._getTileName(a,
d,e),k=c._getTileUrl(a,d,e),h=[a,d,e],m;G.Util.ajax(k,{responseType:c.options.responseType,success:function(a,d){c.onSuccess(h,d);c._tiles[l]=b(h,d);(m=c._map)&&m._requestRedraw()},error:function(a){c.onError(h)},complete:function(a){c.onComplete(h)}})},c.options);c._updateColorsImage()},setUrl:function(a){var b=this._map,d;for(d in this._loadingKeys)this._stopLoadingByKey(d);this.url=a;this._dirtyTiles=this._tiles;this._tiles={};this._loadedKeys={};this._dirty=!0;b&&b._requestUpdate();return this},
clear:function(){var a=this._map,b;for(b in this._loadingKeys)this._stopLoadingByKey(b);this._dirtyTiles={};this._tiles={};this._loadedKeys={};this._dirty=!0;this._onClear();a&&a._requestUpdate();return this},_onResize:function(){var a=this._map,b=Math.max(this.options.drawResolution,1),a=(a._useOffScreen?a._offScreenCtx:a._onScreenCtx).canvas,d=this._ctx.canvas,c=this._actx.canvas,f=G.Browser.getCanvasRatio();this._bkScale=Math.max(f?f[0]||1:1,f?f[1]||1:1)*b;d.width=c.width=a.width/this._bkScale;
d.height=c.height=a.height/this._bkScale;this._dirty=!0},_onViewChanged:function(a){var b=this,d=b._map;setTimeout(function(){b._dirty=!0;d&&d._requestRedraw()},50)},_initContainer:function(){var a=this._map,b=G.DomUtil;this._ctx||(this._ctx=b.create("canvas").getContext("2d"));this._actx||(this._actx=b.create("canvas").getContext("2d"));this._cctx||(this._cctx=G.DomUtil.create("canvas").getContext("2d"));a.addListener("resize",this._onResize,this);this._onResize()},_onAdded:function(){var a=this._map;
this._initContainer();a._requestUpdate();this.addListener("loadTileSuccess",this._onLoadTileSuccess,this);this.addListener("unusedTile",this._onUnusedTile,this);this.addListener("allLoaded",this._onAllLoaded,this);a.addListener("viewChanged",this._onViewChanged,this)},_onRemoved:function(){var a=this._map;this.removeListener("loadTileSuccess",this._onLoadTileSuccess,this);this.removeListener("unusedTile",this._onUnusedTile,this);this.removeListener("allLoaded",this._onAllLoaded,this);a.removeListener("resize",
this._onResize,this);a.removeListener("viewChanged",this._onViewChanged,this)},updateColors:function(){this._updateColorsImage()},_onLoadTileSuccess:function(a){a=this._map;this._dirty=!0;a&&a._requestRedraw()},_onUnusedTile:function(a){a=a.tileInfo;a=this._getTileName(a[0],a[1],a[2]);delete this._tiles[a]},_onAllLoaded:function(a){a=this._map;this._dirtyTiles={};a&&a._requestRedraw()},_onUpdated:function(){this._dirty=!0;this._draw()},_draw:function(){var a=this._map,b=this.options,d=this._ctx,c=
d.canvas,f=c.width,c=c.height;if((b.drawOnAnim||!(a.isZooming()||a.isPinching()||a.isRotating()||a.isPanning()))&&this._dirty){var g,e,l,k,h=this._actx;g=h.canvas;var m=g.width,n=g.height;h.clearRect(0,0,m,n);for(e in this._dirtyTiles)if(this._tiles[e])delete this._dirtyTiles[e];else for(k in g=this._dirtyTiles[e],g)l=g[k],this._filters&&!this._calcFilter(l[3])||this._drawA(l[0],l[1],l[2]);for(e in this._tiles)for(k in g=this._tiles[e],g)l=g[k],this._filters&&!this._calcFilter(l[3])||this._drawA(l[0],
l[1],l[2]);e=h.getImageData(0,0,m,n);h=e.data;m=h.length;g=Math.min(parseInt(255*b.maxOpacity),255);b=Math.min(g,Math.min(parseInt(255*b.minOpacity),255));l=this._colorsImage;var p;for(k=0;k<m-3;k+=4)(n=h[k+3])?(p=4*n,h[k]=l[p],h[k+1]=l[p+1],h[k+2]=l[p+2],h[k+3]=b+(g-b)*n/255):0<b&&(h[k]=l[0],h[k+1]=l[1],h[k+2]=l[2],h[k+3]=b);e.data=h;d.clearRect(0,0,f,c);d.putImageData(e,0,0,0,0,f,c);this._dirty=!1}this._hidden||(a=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,f=a.canvas,a.drawImage(d.canvas,0,
0,f.width,f.height))},_updateColorsImage:function(){var a=G.DomUtil.create("canvas").getContext("2d"),b=a.canvas;b.width=1;b.height=256;var b=this.options.colors,d=a.createLinearGradient(0,0,1,256),c;for(c in b)d.addColorStop(c,b[c]);a.fillStyle=d;a.fillRect(0,0,1,256);this._colorsImage=a.getImageData(0,0,1,256).data;this._dirty=!0},_updateCircle:function(a,b){var d=this._cctx,c=d.canvas,f=a+2*b,g=2*f;c.width=c.height=2*f;d.shadowColor="#000";d.shadowOffsetX=d.shadowOffsetY=g;d.shadowBlur=b;d.beginPath();
d.arc(f-g,f-g,a,0,2*Math.PI,!0);d.closePath();d.fill();this._circleRadius=a;this._circleR=f;return this},_drawA:function(a,b,d){var c=this._map,f=this.options;if(d){var g=f.topValue,e=f.radius/this._bkScale;"map"==f.radiusUnit&&(e/=c._res);this._circleRadius&&this._circleRadius==e||this._updateCircle(e,e);f=this._actx;e=c._canvasOffset;b=c.toScreen([a,b]);a=b[0]+e[0];b=b[1]+e[1];d=Math.min(1,d/g);f.globalAlpha=d;f.drawImage(this._cctx.canvas,a/this._bkScale-this._circleR,b/this._bkScale-this._circleR)}}});
G.Layer.TiledGridHeat=G.Layer.TiledService.extend({mixins:[G.Layer.LOD],options:{cluster:[],responseType:"json",gridCols:64,gridRows:64,maxOpacity:1,minOpacity:0,colors:{"0.2":"#00f","0.4":"#0ff","0.6":"#0f0","0.8":"#ff0",1:"#f00"},topValue:1,drawOnAnim:!1},init:function(a,b,d){var c=this;c.url=a;c._dataFunc=b;c.options=G.Util.merge({},c.options,d);c._tiles={};c._dirtyTiles={};c._dirty=!0;G.Layer.TiledService.prototype.init.call(c,function(a,d,e){var l=c._getTileName(a,d,e),k=c._getTileUrl(a,d,e),
h=[a,d,e],m;G.Util.ajax(k,{responseType:c.options.responseType,success:function(a,d){c.onSuccess(h,d);c._tiles[l]={info:h,data:b(h,d)};(m=c._map)&&m._requestRedraw()},error:function(a){c.onError(h)},complete:function(a){c.onComplete(h)}})},c.options);c._updateColorsImage()},setUrl:function(a){var b=this._map,d;for(d in this._loadingKeys)this._stopLoadingByKey(d);this.url=a;this._dirtyTiles=this._tiles;this._tiles={};this._loadedKeys={};this._dirty=!0;b&&b._requestUpdate();return this},clear:function(){var a=
this._map,b;for(b in this._loadingKeys)this._stopLoadingByKey(b);this._dirtyTiles={};this._tiles={};this._loadedKeys={};this._dirty=!0;this._onClear();a&&a._requestUpdate();return this},_onResize:function(){var a=this._map,a=(a._useOffScreen?a._offScreenCtx:a._onScreenCtx).canvas,b=this._ctx.canvas;b.width=a.width;b.height=a.height;this._dirty=!0},_onViewChanged:function(a){var b=this,d=b._map;setTimeout(function(){b._dirty=!0;d&&d._requestRedraw()},50)},_initContainer:function(){var a=this._map,
b=G.DomUtil;this._ctx||(this._ctx=b.create("canvas").getContext("2d"));a.addListener("resize",this._onResize,this);this._onResize()},_onAdded:function(){var a=this._map;this._initContainer();a._requestUpdate();this.addListener("loadTileSuccess",this._onLoadTileSuccess,this);this.addListener("unusedTile",this._onUnusedTile,this);this.addListener("allLoaded",this._onAllLoaded,this);a.addListener("viewChanged",this._onViewChanged,this)},_onRemoved:function(){var a=this._map;this.removeListener("loadTileSuccess",
this._onLoadTileSuccess,this);this.removeListener("unusedTile",this._onUnusedTile,this);this.removeListener("allLoaded",this._onAllLoaded,this);a.removeListener("resize",this._onResize,this);a.removeListener("viewChanged",this._onViewChanged,this)},updateColors:function(){this._updateColorsImage()},_onLoadTileSuccess:function(a){a=this._map;this._dirty=!0;a&&a._requestRedraw()},_onUnusedTile:function(a){a=a.tileInfo;a=this._getTileName(a[0],a[1],a[2]);delete this._tiles[a]},_onAllLoaded:function(a){a=
this._map;this._dirtyTiles={};a&&a._requestRedraw()},_onUpdated:function(){this._dirty=!0;this._draw()},_draw:function(){var a=this._map,b=this.options,d=this._ctx,c=d.canvas,f=c.width,c=c.height;if((b.drawOnAnim||!(a.isZooming()||a.isPinching()||a.isRotating()||a.isPanning()))&&this._dirty){var g=Math.min(parseInt(255*b.maxOpacity),255),b=Math.min(g,Math.min(parseInt(255*b.minOpacity),255));d.clearRect(0,0,f,c);for(key in this._dirtyTiles)this._tiles[key]?delete this._dirtyTiles[key]:(tile=this._dirtyTiles[key],
this._drawTile(tile,b,g));for(key in this._tiles)tile=this._tiles[key],this._drawTile(tile,b,g);this._dirty=!1}this._hidden||(a=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,f=a.canvas,a.drawImage(d.canvas,0,0,f.width,f.height))},_updateColorsImage:function(){var a=G.DomUtil.create("canvas").getContext("2d"),b=a.canvas;b.width=1;b.height=256;var b=this.options.colors,d=a.createLinearGradient(0,0,1,256),c;for(c in b)d.addColorStop(c,b[c]);a.fillStyle=d;a.fillRect(0,0,1,256);this._colorsImage=a.getImageData(0,
0,1,256).data;this._dirty=!0},_drawTile:function(a,b,d){var c=this._map,f=this.options,g=a._ctx;if(!g){var g=a._tctx=G.DomUtil.create("canvas").getContext("2d"),e=g.canvas,l=e.width=f.gridCols,e=e.height=f.gridRows,k=f.topValue,h=this._colorsImage,m=g.getImageData(0,0,l,e),n=m.data,p=a.data,q;for(q in p){var r=p[q],s=4*((f.gridRows-r[1]-1)*f.gridCols+r[0]),r=Math.min(parseInt(255*(r[2]/k)),255),t=4*r;n[s]=h[t];n[s+1]=h[t+1];n[s+2]=h[t+2];n[s+3]=b+(d-b)*r/255}m.data=n;g.putImageData(m,0,0,0,0,l,e)}b=
Math.round;l=G.Browser.getPxRatio();d=l[0];l=l[1];e=c._res;q=c._rotate;a=a.info;k=parseInt(a[0]);h=parseInt(a[1]);a=parseInt(a[2]);m=f.tileSize*f.zoomReses[a];a=Math.ceil(m/e);e=c.toScreen([f.originX+k*m,f.originY-h*m]);f=e[0];e=e[1];c=c._canvasOffset;f+=c[0];e+=c[1];f=b(f);e=b(e);c=this._ctx;q&&(c.save(),c.translate(f,e),c.rotate(q/G.MathUtil.DEGREE_PER_RADIAN),c.translate(-f,-e));try{c.drawImage(g.canvas,f,e,b(a/d),b(a/l))}catch(u){}q&&c.restore()}});
